<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Limited Liability Company Registration Form</title>
  <style>
    /* Google Fonts Import */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    /* CSS Variables */
    :root {
      --primary-color: #4361ee;
      --primary-dark: #3651de;
      --secondary-color: #3f37c9;
      --success-color: #06ffa5;
      --warning-color: #ffbe0b;
      --danger-color: #fb5607;
      --info-color: #4cc9f0;
      --light-color: #f8f9fa;
      --dark-color: #212529;
      --gray-color: #6c757d;
      --border-radius: 12px;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      --box-shadow-hover: 0 8px 15px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Global Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
      color: var(--dark-color);
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Header */
    h2 {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 24px 32px;
      border-radius: var(--border-radius);
      font-size: 28px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 32px;
      box-shadow: var(--box-shadow);
      letter-spacing: -0.5px;
    }

    /* Form Container */
    .form-container {
      background: white;
      border-radius: var(--border-radius);
      padding: 32px;
      box-shadow: var(--box-shadow-hover);
      margin-bottom: 32px;
    }

    /* Fieldset */
    fieldset {
      margin-bottom: 32px;
      padding: 24px;
      border: 2px solid #e9ecef;
      border-radius: var(--border-radius);
      background: var(--light-color);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    fieldset::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--info-color));
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    fieldset:hover::before {
      transform: scaleX(1);
    }

    fieldset:hover {
      box-shadow: var(--box-shadow-hover);
      transform: translateY(-2px);
    }

    legend {
      background: var(--primary-color);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
    }

    /* Form Groups */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--dark-color);
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Input Fields */
    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      border-radius: 8px;
      border: 2px solid #e9ecef;
      background: white;
      font-size: 15px;
      transition: var(--transition);
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
      transform: translateY(-1px);
    }

    /* Buttons */
    button {
      padding: 12px 24px;
      margin: 8px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: var(--transition);
      box-shadow: var(--box-shadow);
      position: relative;
      overflow: hidden;
    }

    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    button:hover::before {
      width: 300px;
      height: 300px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: var(--box-shadow-hover);
    }

    button:active {
      transform: translateY(0);
    }

    /* Button Variants */
    .btn-add { 
      background: linear-gradient(135deg, var(--secondary-color), var(--primary-color)); 
      color: white;
    }

    .reset-btn {
      background: linear-gradient(135deg, var(--gray-color), #495057);
      color: white;
      margin-top: 20px;
    }

    /* Submit Button */
    [type="submit"] {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      font-size: 16px;
      padding: 14px 32px;
      margin-top: 20px;
      width: 100%;
    }

    /* Dynamic Sections */
    .dynamic-section {
      border: 2px dashed #dee2e6;
      padding: 24px;
      margin-bottom: 20px;
      position: relative;
      border-radius: var(--border-radius);
      background: white;
      transition: var(--transition);
    }

    .dynamic-section:hover {
      border-color: var(--primary-color);
      background: var(--light-color);
    }

    .dynamic-section h4 {
      margin-top: 0;
      color: var(--primary-color);
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .remove-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: linear-gradient(135deg, var(--danger-color), #ff6b35);
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      box-shadow: var(--box-shadow);
    }

    .remove-btn:hover {
      transform: rotate(90deg) scale(1.1);
    }

    /* Address Group */
    .address-group {
      border-left: 4px solid var(--primary-color);
      padding: 20px;
      margin: 20px 0;
      background: var(--light-color);
      border-radius: 0 8px 8px 0;
    }

    .address-group h5 {
      margin-top: 0;
      color: var(--primary-color);
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    /* Two Column Layout */
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      background: linear-gradient(135deg, var(--success-color), #00d084);
      color: var(--dark-color);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow-hover);
      transform: translateX(120%);
      transition: transform 0.3s ease;
      z-index: 1000;
      font-weight: 600;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.error {
      background: linear-gradient(135deg, var(--danger-color), #ff6b35);
      color: white;
    }

    .notification.info {
      background: linear-gradient(135deg, var(--info-color), #00b4d8);
      color: white;
    }

    /* Director Roles Section Styles */
    .director-roles {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      border-left: 4px solid var(--primary-color);
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      font-weight: normal;
      margin-bottom: 0;
      cursor: pointer;
    }

    .checkbox-label input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }

    .checkbox-label span {
      color: var(--dark-color);
    }

    .checkbox-label.disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .checkbox-label.disabled input[type="checkbox"] {
      cursor: not-allowed;
    }

    .share-percent-container {
      margin-top: 10px;
      margin-left: 24px;
      padding: 10px;
      background: #f1f3f5;
      border-radius: 6px;
      border-left: 3px solid var(--primary-color);
    }

    .share-percent-container label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: var(--dark-color);
    }

    .share-percent-container input {
      width: 150px;
    }

    /* Secretary Section Styles */
    .secretary-note {
      background: #e3f2fd;
      border-left: 4px solid var(--info-color);
      padding: 10px 15px;
      margin-bottom: 20px;
      border-radius: 4px;
      font-size: 14px;
      color: var(--dark-color);
    }

    /* Navigation */
    .nav-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .nav-btn {
      background: linear-gradient(135deg, var(--info-color), #00b4d8);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      display: inline-block;
      transition: var(--transition);
    }

    .nav-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--box-shadow-hover);
    }

    /* Owner Info */
    .owner-info {
      background: rgba(255, 255, 255, 0.9);
      border-radius: var(--border-radius);
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: var(--box-shadow);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .owner-info i {
      font-size: 24px;
      color: var(--primary-color);
    }

    .owner-info p {
      margin: 0;
      font-size: 14px;
    }

    .owner-info .owner-name {
      font-weight: 600;
      color: var(--primary-color);
    }

    /* Error State */
    .error-container {
      background: rgba(251, 86, 7, 0.1);
      border: 2px solid var(--danger-color);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
    }

    .error-container h3 {
      color: var(--danger-color);
      margin-bottom: 10px;
    }

    .error-container p {
      color: var(--dark-color);
      margin-bottom: 15px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .form-container {
        padding: 20px;
      }
      
      fieldset {
        padding: 16px;
      }
      
      .two-column {
        grid-template-columns: 1fr;
      }
      
      h2 {
        font-size: 24px;
        padding: 20px;
      }
      
      button {
        padding: 10px 16px;
        font-size: 13px;
      }
      
      .nav-container {
        flex-direction: column;
        gap: 10px;
      }
      
      .share-percent-container input {
        width: 100%;
      }
      
      .owner-info {
        flex-direction: column;
        text-align: center;
      }
    }

    /* Animations */
    @keyframes fadeOut {
      from {
        opacity: 1;
        transform: scale(1);
      }
      to {
        opacity: 0;
        transform: scale(0.9);
      }
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="nav-container">
      <h2 id="mainTitle">Limited Liability Company Registration Form</h2>
      <a href="authenticate.html" class="nav-btn">Owner Login</a>
    </div>

    <!-- Error Container -->
    <div id="errorContainer" class="error-container" style="display: none;">
      <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--danger-color); margin-bottom: 15px;"></i>
      <h3>Invalid Link</h3>
      <p id="errorMessage">The link you're using is not valid. Please contact the person who shared this link with you.</p>
      <a href="authenticate.html" class="btn btn-primary">Go to Login Page</a>
    </div>

    <!-- Owner Information -->
    <div id="ownerInfo" class="owner-info" style="display: none;">
      <i class="fas fa-user-circle"></i>
      <div>
        <p>Submitting form for: <span class="owner-name" id="ownerName"></span></p>
        <p>Owner ID: <span id="ownerId"></span></p>
      </div>
    </div>

    <!-- Form View -->
    <div id="formView" style="display: none;">
      <div class="form-container">
        <form id="mainForm">

          <!-- 1. Company Information -->
          <fieldset id="companyInfo">
            <legend>Company Information</legend>
            <div class="form-group"><label>Company Name</label><input name="Company Name" required></div>
          
            <div class="form-group"><label>Presented By</label><input name="Presented By" required></div>
            <div class="form-group"><label>Presenter TIN</label><input name="Presenter TIN" required></div>
            <div class="form-group"><label>Activities</label><input name="Activities"></div>
            <div class="form-group"><label>Stated Capital</label><input type="number" name="Stated Capital"></div>
            <div class="form-group"><label>Estimated Revenue</label><input type="number" name="Estimated Revenue"></div>
            <div class="form-group"><label>Number of Employees</label><input type="number" name="Number of Employees"></div>
          </fieldset>

          <!-- 2. Office Details -->
          <fieldset id="officeDetails">
            <legend>Office Details</legend>
            <div class="form-group"><label>GPS Address</label><input name="GPS Address"></div>
            <div class="form-group"><label>Landmark</label><input name="Landmark"></div>
            <div class="form-group"><label>Building No.</label><input name="Building No."></div>
            <div class="form-group"><label>Town</label><input name="Town"></div>
            <div class="form-group"><label>Street Name</label><input name="Street Name"></div>
            <div class="form-group"><label>City</label><input name="City"></div>
            <div class="form-group"><label>District</label><input name="District"></div>
            <div class="form-group"><label>Region</label><input name="Region"></div>

            <div class="form-group"><label>Postal Number</label><input name="Postal Number"></div>
            <div class="form-group"><label>Postal Town</label><input name="Postal Town"></div>
            <div class="form-group"><label>Postal Region</label><input name="Postal Region"></div>
            <div class="form-group"><label>Contact 1</label><input name="Contact 1"></div>
            <div class="form-group"><label>Contact 2</label><input name="Contact 2"></div>
            <div class="form-group"><label>Email</label><input name="Email" type="email"></div>
          </fieldset>

          <!-- 3. Directors -->
          <fieldset id="directors">
            <legend>Directors</legend>
            <div id="directorsContainer">
              <div class="dynamic-section">
                <h4>Director 1</h4>
                <div class="director-roles">
                  <div class="checkbox-group">
                    <label class="checkbox-label">
                      <input type="checkbox" name="isSubscriber" onchange="toggleSharePercent(this, 0)">
                      <span>Is also a Subscriber</span>
                    </label>
                    <div class="share-percent-container" style="display: none;">
                      <label>Share Percentage</label>
                      <input type="number" name="sharePercent" min="0" max="100" step="0.01">
                    </div>
                    <label class="checkbox-label">
                      <input type="checkbox" name="isSecretary" onchange="handleSecretarySelection(this, 0)">
                      <span>Is also the Secretary</span>
                    </label>
                  </div>
                </div>
                <div class="two-column">
                  <div class="form-group"><label>First Name</label><input name="First Name"></div>
                  <div class="form-group"><label>Middle Name</label><input name="Middle Name"></div>
                </div>
                <div class="two-column">
                  <div class="form-group"><label>Surname</label><input name="Surname"></div>
                  <div class="form-group"><label>Former Name</label><input name="Former Name"></div>
                </div>
                <div class="two-column">
                  <div class="form-group"><label>Date of Birth</label><input name="Date of Birth" type="text"></div>
                  <div class="form-group"><label>Place of Birth</label><input name="Place of Birth"></div>
                </div>
                <div class="two-column">
                  <div class="form-group"><label>Nationality</label><input name="Nationality" type="text"></div>
                  <div class="form-group"><label>Occupation</label><input name="Occupation"></div>
                </div>
                <div class="two-column">
                  <div class="form-group"><label>Contact 1</label><input name="Contact 1"></div>
                  <div class="form-group"><label>Contact 2</label><input name="Contact 2"></div>
                </div>
                <div class="form-group"><label>Email</label><input name="Email" type="email"></div>
                <div class="two-column">
                  <div class="form-group"><label>TIN</label><input name="TIN"></div>
                  <div class="form-group"><label>Ghana Card</label><input name="Ghana Card"></div>
                </div>
                <div class="address-group">
                  <h5>Residential Address</h5>
                  <div class="two-column">
                    <div class="form-group"><label>GPS</label><input name="GPS"></div>
                    <div class="form-group"><label>House No.</label><input name="House No."></div>
                  </div>
                  <div class="form-group"><label>Landmark</label><input name="Landmark"></div>
                  <div class="form-group"><label>Street</label><input name="Street"></div>
                  <div class="two-column">
                    <div class="form-group"><label>City</label><input name="City"></div>
                    <div class="form-group"><label>Town</label><input name="Town"></div>
                  </div>
                  <div class="two-column">
                    <div class="form-group"><label>District</label><input name="District"></div>
                    <div class="form-group"><label>Region</label><input name="Region"></div>
                  </div>
                  <div class="form-group"><label>Country</label><input name="Country"></div>
                </div>
              </div>
            </div>
            <button type="button" class="btn-add" onclick="addDirector()">Add Director</button>
          </fieldset>

          <!-- 4. Secretary Details -->
          <fieldset id="secretaryDetails">
            <legend>Secretary Details</legend>
            <div class="form-group"><label>Qualification</label><input name="Qualification"></div>
            <div class="two-column">
              <div class="form-group"><label>First Name</label><input name="First Name"></div>
              <div class="form-group"><label>Middle Name</label><input name="Middle Name"></div>
            </div>
            <div class="two-column">
              <div class="form-group"><label>Surname</label><input name="Surname"></div>
              <div class="form-group"><label>Former Name</label><input name="Former Name"></div>
            </div>
            <div class="two-column">
              <div class="form-group"><label>Date of Birth</label><input name="Date of Birth" type="text"></div>
              <div class="form-group"><label>Place of Birth</label><input name="Place of Birth"></div>
            </div>
            <div class="two-column">
              <div class="form-group"><label>Nationality</label><input name="Nationality" type="text"></div>
              <div class="form-group"><label>Occupation</label><input name="Occupation"></div>
            </div>
            <div class="two-column">
              <div class="form-group"><label>Contact 1</label><input name="Contact 1"></div>
              <div class="form-group"><label>Contact 2</label><input name="Contact 2"></div>
            </div>
            <div class="form-group"><label>Email</label><input name="Email" type="email"></div>
            <div class="two-column">
              <div class="form-group"><label>TIN</label><input name="TIN"></div>
              <div class="form-group"><label>Ghana Card</label><input name="Ghana Card"></div>
            </div>
            <div class="address-group">
              <h5>Residential Address</h5>
              <div class="two-column">
                <div class="form-group"><label>GPS</label><input name="GPS"></div>
                <div class="form-group"><label>House No.</label><input name="House No."></div>
              </div>
              <div class="form-group"><label>Landmark</label><input name="Landmark"></div>
              <div class="form-group"><label>Street</label><input name="Street"></div>
              <div class="two-column">
                <div class="form-group"><label>City</label><input name="City"></div>
                <div class="form-group"><label>Town</label><input name="Town"></div>
              </div>
              <div class="two-column">
                <div class="form-group"><label>District</label><input name="District"></div>
                <div class="form-group"><label>Region</label><input name="Region"></div>
              </div>
              <div class="form-group"><label>Country</label><input name="Country"></div>
            </div>
          </fieldset>

          <!-- 5. Subscribers -->
          <fieldset id="subscribers">
            <legend>Subscribers</legend>
            <div id="subscribersContainer">
              <div class="dynamic-section">
                <h4>Subscriber 1</h4>
                <div class="two-column">
                  <div class="form-group"><label>First Name</label><input name="First Name"></div>
                  <div class="form-group"><label>Middle Name</label><input name="Middle Name"></div>
                </div>
                <div class="two-column">
                  <div class="form-group"><label>Surname</label><input name="Surname"></div>
                  <div class="form-group"><label>Former Name</label><input name="Former Name"></div>
                </div>
                <div class="two-column">
                  <div class="form-group"><label>Date of Birth</label><input name="Date of Birth" type="text"></div>
                  <div class="form-group"><label>Place of Birth</label><input name="Place of Birth"></div>
                </div>
                <div class="two-column">
                  <div class="form-group"><label>Nationality</label><input name="Nationality" type="text"></div>
                  <div class="form-group"><label>Occupation</label><input name="Occupation"></div>
                </div>
                <div class="two-column">
                  <div class="form-group"><label>Contact 1</label><input name="Contact 1"></div>
                  <div class="form-group"><label>Contact 2</label><input name="Contact 2"></div>
                </div>
                <div class="form-group"><label>Email</label><input name="Email" type="email"></div>
                <div class="two-column">
                  <div class="form-group"><label>TIN</label><input name="TIN"></div>
                  <div class="form-group"><label>Ghana Card</label><input name="Ghana Card"></div>
                </div>
                <div class="address-group">
                  <h5>Residential Address</h5>
                  <div class="two-column">
                    <div class="form-group"><label>GPS</label><input name="GPS"></div>
                    <div class="form-group"><label>House No.</label><input name="House No."></div>
                  </div>
                  <div class="form-group"><label>Landmark</label><input name="Landmark"></div>
                  <div class="form-group"><label>Street</label><input name="Street"></div>
                  <div class="two-column">
                    <div class="form-group"><label>City</label><input name="City"></div>
                    <div class="form-group"><label>Town</label><input name="Town"></div>
                  </div>
                  <div class="two-column">
                    <div class="form-group"><label>District</label><input name="District"></div>
                    <div class="form-group"><label>Region</label><input name="Region"></div>
                  </div>
                </div>
              </div>
            </div>
            <button type="button" class="btn-add" onclick="addSubscriber()">Add Subscriber</button>
          </fieldset>

          <button type="submit">Submit Form</button>
          <button type="button" class="reset-btn" onclick="resetForm()">Reset Form</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Notification element -->
  <div id="notification" class="notification"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  
  <script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBzSHkVxRiLC5gsq04LTTDnXaGdoF7eJ2c",
        authDomain: "easyregistrationforms.firebaseapp.com",
        projectId: "easyregistrationforms",
        storageBucket: "easyregistrationforms.firebasestorage.app",
        messagingSenderId: "589421628989",
        appId: "1:589421628989:web:d9f6e9dbe372ab7acd6454",
        measurementId: "G-GVCPBN8VB5"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Initialize the system
    let selectedSecretaryIndex = -1; // Track which director is selected as secretary
    let ownerID = null;
    let ownerData = null;
    const FORM_TYPE = 'llc'; // This form type identifier

    // Get owner ID from URL parameters
    document.addEventListener('DOMContentLoaded', function() {
      const params = new URLSearchParams(window.location.search);
      ownerID = params.get("owner");
      
      console.log('Owner ID from URL:', ownerID);
      
      if (ownerID) {
        // Fetch owner data
        fetchOwnerData(ownerID);
      } else {
        // No owner ID in URL, show error
        showError('No owner ID provided in the link. Please contact the person who shared this link with you.');
      }
    });

    // Fetch owner data function
    function fetchOwnerData(ownerId) {
      console.log('Fetching owner data for ID:', ownerId);
      showNotification('Validating your link...', 'info');
      
      // Try to find the owner by uniqueId
      db.collection('users').where('uniqueId', '==', ownerId).get()
        .then((querySnapshot) => {
          if (querySnapshot.empty) {
            console.log('No owner found with uniqueId:', ownerId);
            
            // Try to find by email (in case the link contains email)
            db.collection('users').where('email', '==', ownerId).get()
              .then((emailQuery) => {
                if (emailQuery.empty) {
                  console.log('No owner found with email either:', ownerId);
                  showError('The owner ID in your link is not valid. Please contact the person who shared this link with you.');
                } else {
                  console.log('Owner found by email:', emailQuery.docs[0].data());
                  const doc = emailQuery.docs[0];
                  ownerData = doc.data();
                  displayOwnerInfo();
                }
              })
              .catch((emailError) => {
                console.error("Error checking email:", emailError);
                showError('Error loading owner information. Please try again later or contact support.');
              });
            return;
          }
          
          // Get the first matching document
          const doc = querySnapshot.docs[0];
          ownerData = doc.data();
          
          console.log('Owner data found:', ownerData);
          displayOwnerInfo();
        })
        .catch((error) => {
          console.error("Error getting owner data:", error);
          showError('Error loading owner information. Please try again later or contact support.');
        });
    }

    // Display owner info
    function displayOwnerInfo() {
      // Display owner information
      document.getElementById('ownerInfo').style.display = 'flex';
      document.getElementById('ownerName').textContent = ownerData.firstName || 'Unknown';
      document.getElementById('ownerId').textContent = ownerID;
      document.getElementById('mainTitle').textContent = `Limited Liability Company Registration Form - ${ownerData.firstName || 'Unknown'}`;
      
      // Show the form
      document.getElementById('formView').style.display = 'block';
      document.getElementById('errorContainer').style.display = 'none';
      
      showNotification('Link validated successfully! You can now submit your data.', 'success');
    }

    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorContainer').style.display = 'block';
      document.getElementById('formView').style.display = 'none';
      document.getElementById('ownerInfo').style.display = 'none';
    }

    // Form submission handler
    document.getElementById('mainForm').addEventListener('submit', function(e){
      e.preventDefault();
      
      if (!ownerID) {
        showNotification('Form submission failed. Invalid owner link.', 'error');
        return;
      }
      
      const clientId = generateClientId();
      const submittedAt = new Date().toISOString();
      
      // Collect all form data
      const formData = {};
      
      // Company Information
      const companyInfo = document.getElementById('companyInfo');
      companyInfo.querySelectorAll('input, select').forEach(inp => {
        formData[`company_${inp.name}`] = inp.value.trim();
      });
      
      // Office Details
      const officeDetails = document.getElementById('officeDetails');
      officeDetails.querySelectorAll('input, select').forEach(inp => {
        formData[`office_${inp.name}`] = inp.value.trim();
      });
      
      // Directors - Flatten the structure
      const directors = [];
      document.querySelectorAll('#directorsContainer .dynamic-section').forEach((section, index) => {
        const directorData = {};
        section.querySelectorAll('input, select').forEach(inp => {
          directorData[`director${index}_${inp.name}`] = inp.value.trim();
        });
        directors.push(directorData);
      });
      
      // Director Roles - Flatten the structure
      const directorRoles = [];
      document.querySelectorAll('#directorsContainer .dynamic-section').forEach((section, index) => {
        const isSubscriber = section.querySelector('input[name="isSubscriber"]').checked;
        const isSecretary = section.querySelector('input[name="isSecretary"]').checked;
        const sharePercent = isSubscriber ? section.querySelector('input[name="sharePercent"]').value : '';
        
        directorRoles.push({
          [`director${index}_isSubscriber`]: isSubscriber,
          [`director${index}_isSecretary`]: isSecretary,
          [`director${index}_sharePercent`]: sharePercent
        });
      });
      
      // Secretary - Flatten the structure
      const secretary = {};
      if (selectedSecretaryIndex === -1) {
        document.querySelectorAll('#secretaryDetails input, #secretaryDetails select').forEach(inp => {
          secretary[`secretary_${inp.name}`] = inp.value.trim();
        });
      }
      
      // Subscribers - Flatten the structure
      const subscribers = [];
      document.querySelectorAll('#subscribersContainer .dynamic-section').forEach((section, index) => {
        const subscriberData = {};
        section.querySelectorAll('input, select').forEach(inp => {
          subscriberData[`subscriber${index}_${inp.name}`] = inp.value.trim();
        });
        subscribers.push(subscriberData);
      });
      
      // Create client data object with flattened structure
      const clientData = {
        id: clientId,
        submittedAt: submittedAt,
        formType: FORM_TYPE,
        ...formData,
        directorsCount: directors.length,
        subscribersCount: subscribers.length,
        ...directorRoles.reduce((acc, role) => ({...acc, ...role}), {}),
        ...secretary,
        ...directors.reduce((acc, director) => ({...acc, ...director}), {}),
        ...subscribers.reduce((acc, subscriber) => ({...acc, ...subscriber}), {}),
        ownerId: ownerID,
        ownerName: ownerData ? ownerData.firstName : 'Unknown'
      };
      
      console.log('Client data to save:', clientData);
      
      // Save to Firestore under the form-specific collection
      saveClientToFirestore(clientData);
    });

    function generateClientId() {
      return `${FORM_TYPE}_client_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }

    function saveClientToFirestore(clientData) {
      showNotification('Submitting your data...', 'info');
      
      console.log('Attempting to save client data:', clientData);
      
      // Create the owner document if it doesn't exist
      db.collection('owners').doc(ownerID).get()
        .then((doc) => {
          if (!doc.exists) {
            console.log('Owner document does not exist, creating it');
            return db.collection('owners').doc(ownerID).set({
              ownerId: ownerID,
              ownerName: ownerData ? ownerData.firstName : 'Unknown',
              ownerEmail: ownerData ? ownerData.email : 'Unknown',
              createdAt: new Date().toISOString()
            });
          } else {
            console.log('Owner document exists');
            return Promise.resolve();
          }
        })
        .then(() => {
          // Save to form-specific collection: owners/{ownerID}/{FORM_TYPE}_clients/{clientID}
          console.log(`Saving client data to: owners/${ownerID}/${FORM_TYPE}_clients/${clientData.id}`);
          return db.collection('owners').doc(ownerID).collection(`${FORM_TYPE}_clients`).doc(clientData.id).set(clientData);
        })
        .then(() => {
          console.log('Client data saved successfully');
          showNotification('Your data has been submitted successfully! Thank you.', 'success');
          
          // Try to update the usage count for this specific form type
          db.collection('users').where('uniqueId', '==', ownerID).get()
            .then((querySnapshot) => {
              if (!querySnapshot.empty) {
                const ownerDoc = querySnapshot.docs[0];
                console.log('Updating usage count for owner:', ownerDoc.id);
                
                // Update both total usage and form-specific usage
                updateUsageCount(ownerDoc.id);
              } else {
                console.log('No owner found in users collection with uniqueId:', ownerID);
              }
            })
            .catch((error) => {
              console.error('Error finding owner for usage count update:', error);
              // Don't show error to user since the main submission succeeded
            });
          
          // Reset form after successful submission
          setTimeout(() => {
            resetForm();
          }, 2000);
        })
        .catch((error) => {
          console.error("Error submitting form:", error);
          showNotification('Error submitting your data. Please try again.', 'error');
        });
    }

    // Separate function to update usage count
    function updateUsageCount(ownerDocId) {
      // Use a transaction to safely update the counts
      db.runTransaction((transaction) => {
        const ownerDocRef = db.collection('users').doc(ownerDocId);
        return transaction.get(ownerDocRef).then((doc) => {
          if (!doc.exists) {
            throw new Error("Owner document does not exist!");
          }
          
          const data = doc.data();
          const newTotalUsageCount = (data.usage_count || 0) + 1;
          
          // Update form-specific usage count
          const formUsage = data.formUsage || {};
          const newFormUsageCount = (formUsage[FORM_TYPE] || 0) + 1;
          formUsage[FORM_TYPE] = newFormUsageCount;
          
          // Update both total and form-specific usage
          transaction.update(ownerDocRef, { 
            usage_count: newTotalUsageCount,
            formUsage: formUsage
          });
          
          return { total: newTotalUsageCount, form: newFormUsageCount };
        });
      })
      .then((counts) => {
        console.log('Usage counts updated successfully:', counts);
      })
      .catch((error) => {
        console.error('Error updating usage count:', error);
      });
    }
    
    // Toggle Share Percentage input based on Subscriber checkbox
    function toggleSharePercent(checkbox, directorIndex) {
      const sharePercentContainer = checkbox.closest('.director-roles').querySelector('.share-percent-container');
      sharePercentContainer.style.display = checkbox.checked ? 'block' : 'none';
    }

    // Handle Secretary selection
    function handleSecretarySelection(checkbox, directorIndex) {
      if (checkbox.checked) {
        // Set this director as the secretary
        selectedSecretaryIndex = directorIndex;
        
        // Hide the Secretary Details fieldset
        document.getElementById('secretaryDetails').style.display = 'none';
        
        // Disable all other secretary checkboxes
        const allSecretaryCheckboxes = document.querySelectorAll('input[name="isSecretary"]');
        allSecretaryCheckboxes.forEach((cb, index) => {
          if (index !== directorIndex) {
            cb.checked = false;
            cb.disabled = true;
            cb.closest('.checkbox-label').classList.add('disabled');
          }
        });
      } else {
        // Unset this director as secretary
        selectedSecretaryIndex = -1;
        
        // Show the Secretary Details fieldset
        document.getElementById('secretaryDetails').style.display = 'block';
        
        // Enable all secretary checkboxes
        const allSecretaryCheckboxes = document.querySelectorAll('input[name="isSecretary"]');
        allSecretaryCheckboxes.forEach(cb => {
          cb.disabled = false;
          cb.closest('.checkbox-label').classList.remove('disabled');
        });
      }
    }

    // Dynamic section functions
    function addDirector() {
      const container = document.getElementById('directorsContainer');
      const currentCount = container.querySelectorAll('.dynamic-section').length;
      const newCount = currentCount + 1;
      
      // Add new director section with roles
      const newDirector = document.createElement('div');
      newDirector.className = 'dynamic-section';
      newDirector.innerHTML = `
        <button type="button" class="remove-btn" onclick="removeEntry(this, 'directors')">×</button>
        <h4>Director ${newCount}</h4>
        <div class="director-roles">
          <div class="checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" name="isSubscriber" onchange="toggleSharePercent(this, ${currentCount})">
              <span>Is also a Subscriber</span>
            </label>
            <div class="share-percent-container" style="display: none;">
              <label>Share Percentage</label>
              <input type="number" name="sharePercent" min="0" max="100" step="0.01">
            </div>
            <label class="checkbox-label ${selectedSecretaryIndex !== -1 ? 'disabled' : ''}">
              <input type="checkbox" name="isSecretary" onchange="handleSecretarySelection(this, ${currentCount})" ${selectedSecretaryIndex !== -1 ? 'disabled' : ''}>
              <span>Is also the Secretary</span>
            </label>
          </div>
        </div>
        <div class="two-column">
          <div class="form-group"><label>First Name</label><input name="First Name"></div>
          <div class="form-group"><label>Middle Name</label><input name="Middle Name"></div>
        </div>
        <div class="two-column">
          <div class="form-group"><label>Surname</label><input name="Surname"></div>
          <div class="form-group"><label>Former Name</label><input name="Former Name"></div>
        </div>
        <div class="two-column">
          <div class="form-group"><label>Date of Birth</label><input name="Date of Birth" type="text"></div>
          <div class="form-group"><label>Place of Birth</label><input name="Place of Birth"></div>
        </div>
        <div class="two-column">
          <div class="form-group"><label>Nationality</label><input name="Nationality" type="text"></div>
          <div class="form-group"><label>Occupation</label><input name="Occupation"></div>
        </div>
        <div class="two-column">
          <div class="form-group"><label>Contact 1</label><input name="Contact 1"></div>
          <div class="form-group"><label>Contact 2</label><input name="Contact 2"></div>
        </div>
        <div class="form-group"><label>Email</label><input name="Email" type="email"></div>
        <div class="two-column">
          <div class="form-group"><label>TIN</label><input name="TIN"></div>
          <div class="form-group"><label>Ghana Card</label><input name="Ghana Card"></div>
        </div>
        <div class="address-group">
          <h5>Residential Address</h5>
          <div class="two-column">
            <div class="form-group"><label>GPS</label><input name="GPS"></div>
            <div class="form-group"><label>House No.</label><input name="House No."></div>
          </div>
          <div class="form-group"><label>Landmark</label><input name="Landmark"></div>
          <div class="form-group"><label>Street</label><input name="Street"></div>
          <div class="two-column">
            <div class="form-group"><label>City</label><input name="City"></div>
            <div class="form-group"><label>Town</label><input name="Town"></div>
          </div>
          <div class="two-column">
            <div class="form-group"><label>District</label><input name="District"></div>
            <div class="form-group"><label>Region</label><input name="Region"></div>
          </div>
          <div class="form-group"><label>Country</label><input name="Country"></div>
        </div>
      `;
      container.appendChild(newDirector);
    }

    function addSubscriber() {
      const container = document.getElementById('subscribersContainer');
      const currentCount = container.querySelectorAll('.dynamic-section').length;
      const newCount = currentCount + 1;
      
      const newSubscriber = document.createElement('div');
      newSubscriber.className = 'dynamic-section';
      newSubscriber.innerHTML = `
        <button type="button" class="remove-btn" onclick="removeEntry(this, 'subscribers')">×</button>
        <h4>Subscriber ${newCount}</h4>
        <div class="two-column">
          <div class="form-group"><label>First Name</label><input name="First Name"></div>
          <div class="form-group"><label>Middle Name</label><input name="Middle Name"></div>
        </div>
        <div class="two-column">
          <div class="form-group"><label>Surname</label><input name="Surname"></div>
          <div class="form-group"><label>Former Name</label><input name="Former Name"></div>
        </div>
        <div class="two-column">
          <div class="form-group"><label>Date of Birth</label><input name="Date of Birth" type="text"></div>
          <div class="form-group"><label>Place of Birth</label><input name="Place of Birth"></div>
        </div>
        <div class="two-column">
          <div class="form-group"><label>Nationality</label><input name="Nationality" type="text"></div>
          <div class="form-group"><label>Occupation</label><input name="Occupation"></div>
        </div>
        <div class="two-column">
          <div class="form-group"><label>Contact 1</label><input name="Contact 1"></div>
          <div class="form-group"><label>Contact 2</label><input name="Contact 2"></div>
        </div>
        <div class="form-group"><label>Email</label><input name="Email" type="email"></div>
        <div class="two-column">
          <div class="form-group"><label>TIN</label><input name="TIN"></div>
          <div class="form-group"><label>Ghana Card</label><input name="Ghana Card"></div>
        </div>
        <div class="address-group">
          <h5>Residential Address</h5>
          <div class="two-column">
            <div class="form-group"><label>GPS</label><input name="GPS"></div>
            <div class="form-group"><label>House No.</label><input name="House No."></div>
          </div>
          <div class="form-group"><label>Landmark</label><input name="Landmark"></div>
          <div class="form-group"><label>Street</label><input name="Street"></div>
          <div class="two-column">
            <div class="form-group"><label>City</label><input name="City"></div>
            <div class="form-group"><label>Town</label><input name="Town"></div>
          </div>
          <div class="two-column">
            <div class="form-group"><label>District</label><input name="District"></div>
            <div class="form-group"><label>Region</label><input name="Region"></div>
          </div>
        </div>
      `;
      container.appendChild(newSubscriber);
    }

    function removeEntry(button, type) {
      const section = button.closest('.dynamic-section');
      const index = Array.from(section.parentNode.querySelectorAll('.dynamic-section')).indexOf(section);
      
      section.style.animation = 'fadeOut 0.3s ease-out';
      
      setTimeout(() => {
        section.remove();
        
        // Check if this director was selected as secretary
        if (type === 'directors') {
          const secretaryCheckbox = section.querySelector('input[name="isSecretary"]');
          if (secretaryCheckbox && secretaryCheckbox.checked) {
            // Reset secretary selection
            selectedSecretaryIndex = -1;
            // Show secretary details section
            document.getElementById('secretaryDetails').style.display = 'block';
            // Enable all secretary checkboxes
            const allSecretaryCheckboxes = document.querySelectorAll('input[name="isSecretary"]');
            allSecretaryCheckboxes.forEach(cb => {
              cb.disabled = false;
              cb.closest('.checkbox-label').classList.remove('disabled');
            });
          }
        }
        
        // Renumber the remaining entries
        if (type === 'directors') {
          updateDirectorNumbers();
        } else if (type === 'subscribers') {
          updateSubscriberNumbers();
        }
      }, 300);
    }

    function updateDirectorNumbers() {
      const container = document.getElementById('directorsContainer');
      const directors = container.querySelectorAll('.dynamic-section');
      
      directors.forEach((director, index) => {
        const newNumber = index + 1;
        const h4 = director.querySelector('h4');
        if (h4) {
          h4.textContent = `Director ${newNumber}`;
        }
        
        // Update the onchange handler for the subscriber checkbox
        const subscriberCheckbox = director.querySelector('input[name="isSubscriber"]');
        if (subscriberCheckbox) {
          subscriberCheckbox.setAttribute('onchange', `toggleSharePercent(this, ${index})`);
        }
        
        // Update the onchange handler for the secretary checkbox
        const secretaryCheckbox = director.querySelector('input[name="isSecretary"]');
        if (secretaryCheckbox) {
          secretaryCheckbox.setAttribute('onchange', `handleSecretarySelection(this, ${index})`);
        }
      });
    }

    function updateSubscriberNumbers() {
      const container = document.getElementById('subscribersContainer');
      const subscribers = container.querySelectorAll('.dynamic-section');
      
      subscribers.forEach((subscriber, index) => {
        const newNumber = index + 1;
        const h4 = subscriber.querySelector('h4');
        if (h4) {
          h4.textContent = `Subscriber ${newNumber}`;
        }
      });
    }

    function resetForm() {
      if (confirm('Are you sure you want to reset the form? All data will be lost.')) {
        document.getElementById('mainForm').reset();
        selectedSecretaryIndex = -1;
        document.getElementById('secretaryDetails').style.display = 'block';
        
        // Enable all secretary checkboxes
        const allSecretaryCheckboxes = document.querySelectorAll('input[name="isSecretary"]');
        allSecretaryCheckboxes.forEach(cb => {
          cb.disabled = false;
          cb.closest('.checkbox-label').classList.remove('disabled');
        });
        
        // Hide all share percentage containers
        const sharePercentContainers = document.querySelectorAll('.share-percent-container');
        sharePercentContainers.forEach(container => {
          container.style.display = 'none';
        });
        
        showNotification('Form has been reset');
      }
    }

    function showNotification(message, type) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
  </script>
</body>
</html>